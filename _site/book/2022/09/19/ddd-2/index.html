<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
<meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>


<meta name="description" content="2.1 아키텍처
2.2 계층 구조 아키텍처
2.3 DIP
2.4 도메인 영역의 주요 구성요소
2.5 요청 처리 흐름
2.6 인프라스트럭처
2.7 모듈 구성
" />
<meta property="og:description" content="2.1 아키텍처
2.2 계층 구조 아키텍처
2.3 DIP
2.4 도메인 영역의 주요 구성요소
2.5 요청 처리 흐름
2.6 인프라스트럭처
2.7 모듈 구성
" />

<meta name="author" content="Chloe" />


<meta property="og:title" content="도메인 주도 개발 시작하기 - 2. 아키텍처 개요" />
<meta property="twitter:title" content="도메인 주도 개발 시작하기 - 2. 아키텍처 개요" />



    <title>도메인 주도 개발 시작하기 - 2. 아키텍처 개요 – Chloe – 조금씩, 천천히, 꾸준히</title>

    <link rel="stylesheet" type="text/css" href="/style.css"/>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/ress/dist/ress.min.css"/>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/image/favicon.ico">
    <link rel="icon" type="image/x-icon" href="/assets/image/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-config" content="/assets/image/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <link rel="alternate" type="application/rss+xml" title="Chloe - 조금씩, 천천히, 꾸준히" href="/feed.xml"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous" media="print" onload="this.media='all'"/>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.6.5/plyr.css" media="print" onload="this.media='all'"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" media="print" onload="this.media='all'"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous" media="print" onload="this.media='all'"/>

  </head>

  <body>
    </div>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/assets/image/avatar.png" width="70" height="70" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Chloe</a></h1>
            <p class="site-description">조금씩, 천천히, 꾸준히</p>
          </div>

          <nav class="nav-menu">
            
  <a class="nav-menu-item"<a href="/">Blog</a>

  <a class="nav-menu-item"<a href="/tags">Tag</a>

  <a class="nav-menu-item"<a href="/about">About</a>

  <a class="nav-menu-item"<a href="/search">Search</a>


          </nav>
        </header>
      </div>
    </div>

    <div class="post-container">
      <div id="category" class="category">
        <aside>
          
          
            
              
            
          
            
              
              <a class="category-link " href="/category/Book/">
                <i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbspBook
              </a>
              
            
          
            
              
              <a class="category-link " href="/category/Daily/">
                <i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbspDaily
              </a>
              
            
          
            
              
              <a class="category-link " href="/category/Programming/">
                <i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbspProgramming
              </a>
              
            
          
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </aside>
      </div>
      <div id="main" role="main" class="content">
        <article class="post">
  <div class="post-title">

    <p class="title">도메인 주도 개발 시작하기 - 2. 아키텍처 개요</p>

    <div class="post-option">
      <!--<div class="post-categories">
        <i class="fa fa-tags fa-fw" aria-hidden="true"></i>&nbsp;Tags:&nbsp;
        
        
        <a class="categories-button"<a href="/categories/#Book">Book</a>
        
        
      </div>-->
      <div class="date">
        <i class="fa fa-calendar fa-fw" aria-hidden="true"></i>&nbsp;Date: 2022-09-19
      </div>
    </div>
  </div>

  <div class="entry">
    <p class="notice-list"><a href="#21-아키텍처">2.1 아키텍처</a><br />
<a href="#22-계층-구조-아키텍처">2.2 계층 구조 아키텍처</a><br />
<a href="#23-dip">2.3 DIP</a><br />
<a href="#24-도메인-영역의-주요-구성요소">2.4 도메인 영역의 주요 구성요소</a><br />
<a href="#25-요청-처리-흐름">2.5 요청 처리 흐름</a><br />
<a href="#26-인프라스트럭처">2.6 인프라스트럭처</a><br />
<a href="#27-모듈-구성">2.7 모듈 구성</a></p>

<h2 id="21-아키텍처">2.1 아키텍처</h2>

<ul>
  <li>
    <p>아키텍처를 설계할 때 전형적인 네 가지 영역</p>

    <p><strong>① 표현 영역</strong></p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">HTTP 요청</code> → <code class="language-plaintext highlighter-rouge">요청 변환</code> → <code class="language-plaintext highlighter-rouge">응용 영역에 전달</code> → <code class="language-plaintext highlighter-rouge">응답 변환</code> → <code class="language-plaintext highlighter-rouge">응답 전송</code></li>
      <li>스프링 MVC 프레임워크가 표현 영역을 위한 기술에 해당한다.</li>
    </ul>

    <p><strong>② 응용 영역</strong></p>

    <ul>
      <li>시스템에서 사용자에게 제공해야 할 기능을 구현한다.</li>
      <li><strong>기능을 구현하기 위해 도메인 영역의 도메인 모델을 사용한다.</strong></li>
      <li><strong>응용 서비스는 로직을 직접 수행하기보다 도메인 모델에 로직 수행을 위임한다.</strong></li>
    </ul>

    <p><strong>③ 도메인 영역</strong></p>

    <ul>
      <li><strong>도메인 영역은 도메인 모델을 구현한다.</strong></li>
      <li><strong>도메인 모델은 도메인의 핵심 로직을 구현한다.</strong></li>
      <li>주문 도메인은 <em>배송지 변경, 결제 완료, 주문 총액 계산</em>과 같은 핵심 로직을 도메인 모델에서 구현한다.</li>
    </ul>

    <p><strong>④ 인프라스트럭처 영역</strong></p>

    <ul>
      <li>인프라스트럭처 영역은 구현 기술에 대한 것을 다룬다.</li>
      <li><em>RDBMS 연동, 메세징 큐, 몽고DB, 레디스 연동, SMTP 메일 발송, HTTP 클라이언트</em></li>
      <li>표현 영역, 응용 영역, 도메인 영역은 구현 기술을 사용한 코드를 직접 만들지 않고, 인프라스트럭처 영역에서 제공하는 기능을 사용해서 필요한 기술을 개발한다.</li>
      <li><em>DB 모듈</em>을 사용하여 데이터를 조회, <em>SMTP 모듈</em>을 이용해서 메일을 발송</li>
    </ul>
  </li>
</ul>

<h2 id="22-계층-구조-아키텍처">2.2 계층 구조 아키텍처</h2>

<ul>
  <li>계층 구조는 그 특성상 상위 계층에서 하위 계층으로만 의존한다.</li>
  <li>인프라스트럭처 계층이 도메인을 의존하거나 도메인이 응용 계층에 의존하지 않는다.</li>
  <li>계층 구조를 엄격하게 적용한다면 상위 계층은 바로 아래의 계층에만 의존을 가져야 하지만 구현의 편리함을 위해 계층 구조를 유연하게 적용하기도 한다.</li>
  <li>응용 계층은 도메인 계층에 의존하면서 외부 시스템과의 연동을 위해 더 아래 계층인 인프라스트럭처 계층에 의존하기도 한다.</li>
  <li>계층 구조를 사용하면 아키텍처를 직관적으로 이해하기 쉽다는 장점이 있다.</li>
  <li>계층 구조의 중요한 특징 중 하나는 <strong>표현, 응용, 도메인 계층은 인프라스트럭처 계층에 종속된다.</strong></li>
  <li>도메인의 가격 계산 규칙의 예
    <ul>
      <li>룰 엔진을사용해서 계산 로직을 수행하는 인프라스트럭처 영역의 코드</li>
      <li><code class="language-plaintext highlighter-rouge">Drools</code> : 할인 금액을 계산하기 위한 룰 엔진</li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">DroolsRuleEngine</code> : 룰 엔진의 가격 계산을 수행
(* Drools는 전방 및 후방 추론 기반 룰 엔진을 갖춘 BRMS이다.)</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">DroolsRuleEngine</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">KieContainer</span> <span class="n">kContainer</span><span class="o">;</span>
      
      <span class="kd">public</span> <span class="nf">DroolsRuleEngine</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">KieServices</span> <span class="n">ks</span> <span class="o">=</span> <span class="nc">KieServices</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
          <span class="n">kContainer</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="na">getKieClasspathContainer</span><span class="o">();</span>
      <span class="o">}</span>
      
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">evalute</span><span class="o">(</span><span class="nc">String</span> <span class="n">sessionName</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">facts</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">KieSession</span> <span class="n">kSession</span> <span class="o">=</span> <span class="n">kContainer</span><span class="o">.</span><span class="na">newKieSession</span><span class="o">(</span><span class="n">sessionName</span><span class="o">);</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="n">facts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">kSession</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">x</span><span class="o">));</span>
              <span class="n">kSession</span><span class="o">.</span><span class="na">fireAllRules</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
              <span class="n">kSession</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>        </div>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculateDiscountService</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">DroolsRuleEngine</span> <span class="n">ruleEngine</span><span class="o">;</span>
      
      <span class="kd">public</span> <span class="nf">CalculateDiscountService</span><span class="o">(</span><span class="nc">DroolsRuleEngine</span> <span class="n">ruleEngine</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ruleEngine</span> <span class="o">=</span> <span class="n">ruleEngine</span><span class="o">;</span>
      <span class="o">}</span>
      
      <span class="kd">public</span> <span class="nc">Money</span> <span class="nf">calculateDiscount</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="o">,</span> <span class="nc">String</span> <span class="n">customerId</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">findCustomer</span><span class="o">(</span><span class="n">customerId</span><span class="o">);</span>
      
          <span class="nc">MutableMoney</span> <span class="n">money</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutableMoney</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
          <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">facts</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
          <span class="n">facts</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">orderLines</span><span class="o">);</span>
          <span class="n">ruleEngine</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"discountCalculation"</span><span class="o">,</span> <span class="n">facts</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">money</span><span class="o">.</span><span class="na">toImmutableMoney</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>        </div>

        <ul>
          <li><code class="language-plaintext highlighter-rouge">Drools</code>의 세션 이름을 변경하면 <code class="language-plaintext highlighter-rouge">CalculateDiscountService</code>의 코드도 함께 변경해야 한다.</li>
          <li><code class="language-plaintext highlighter-rouge">MutableMoney</code>는 연산 결과값을 보관하기 위한 데이터 타입으로, 다른 방식을 사용하면 필요 없다.</li>
        </ul>

        <p>➡️  <code class="language-plaintext highlighter-rouge">CalculateDiscountService</code> 가 직접적으로 인프라스트럭처 기술에 의존하는것 같지 않아보여도, 실제로는 의존하고 있는 코드로 인해 변경사항에 유연하지 못하게 된다.<br />
<br /></p>
        <blockquote>
          <p>상위 계층이 인프라스트럭처 계층에 종속되면 두 가지 문제점이 있다.<br />
    1. 테스트하기 어렵다.<br />
    2. 구현 방식을 변경하기 어렵다.</p>
        </blockquote>
      </li>
    </ul>
  </li>
</ul>

<h2 id="23-dip">2.3 DIP</h2>

<ul>
  <li>앞서 살펴본 계층 구조 아키텍처에서의 문제점을 DIP를 통해 해결할 수 있다.</li>
  <li>
    <p>DIP 개념을 이해하기 위해 고수준 모델과 저수준 모델의 차이를 이해할 필요가 있다.</p>

    <ul>
      <li><strong>고수준 모듈</strong>
        <ul>
          <li>의미 있는 단일 기능을 제공하는 모듈이다.</li>
          <li><code class="language-plaintext highlighter-rouge">CalculateDiscountService</code>의 <em>가격 할인 계산</em> 기능</li>
          <li>고수준 모듈의 기능을 구현하려면 여러 하위 기능이 필요하다.</li>
          <li><em>가격 할인 계산</em> 기능을 구현하기 위해서는 <em>고객 정보</em>와 <em>할인 룰 엔진</em>이 필요</li>
        </ul>
      </li>
      <li><strong>저수준 모듈</strong>
        <ul>
          <li>하위 기능을 실제로 구현한 것이다.</li>
          <li>JPA를 이용해 고객 정보 조회, Drools를 이용해 룰을 실행</li>
        </ul>
      </li>
    </ul>

    <p>➡️  고수준 모듈이 제대로 동작하려면 저수준 모듈을 사용해야 한다.
고수준 모듈이 저수준 모듈을 사용하면 앞서 계층 구조 아키텍처의 문제점이 발생하게 된다.</p>
  </li>
  <li>
    <p><strong>DIP는 저수준 모듈이 고수준 모듈에 의존하도록 추상화한 인터페이스를 사용한다.</strong></p>
  </li>
  <li>계층형 아키텍처에 DIP를 적용한 예
    <ul>
      <li>
        <p>룰을 적용하기 위해 추상화된 인터페이스를 사용하도록 한다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RuleDiscounter</span> <span class="o">{</span>
      <span class="nc">Money</span> <span class="nf">applyRules</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>룰을 적용하는 <code class="language-plaintext highlighter-rouge">RuleDiscounter</code>의 구현 객체는 생성자를 통해 전달받는다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculateDiscountService</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">CustomerRepository</span> <span class="n">customerRepository</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">RuleDiscounter</span> <span class="n">ruleDiscounter</span><span class="o">;</span>
      
      <span class="kd">public</span> <span class="nf">CalculateDiscountService</span><span class="o">(</span><span class="nc">CustomerRepository</span> <span class="n">customerRepository</span><span class="o">,</span> 
                                                                          <span class="nc">RuleDiscounter</span> <span class="n">ruleDiscounter</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">this</span><span class="o">.</span><span class="na">customerRepository</span> <span class="o">=</span> <span class="n">customerRepository</span><span class="o">;</span>
          <span class="k">this</span><span class="o">.</span><span class="na">ruleDiscounter</span> <span class="o">=</span> <span class="n">ruleDiscounter</span><span class="o">;</span>
      <span class="o">}</span>
          
      <span class="kd">public</span> <span class="nc">Money</span> <span class="nf">calculateDiscount</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="o">,</span> <span class="nc">String</span> <span class="n">customerId</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">findCustomer</span><span class="o">(</span><span class="n">customerId</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">ruleDiscounter</span><span class="o">.</span><span class="na">applyRules</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">orderLines</span><span class="o">);</span>
      <span class="o">}</span>
          <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>할인 룰 적용을 구현한 클래스는 <code class="language-plaintext highlighter-rouge">RuleDiscounter</code> 인터페이스를 상속받아 구현한다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">DroolsRuleDiscounter</span> <span class="kd">implements</span> <span class="nc">RuleDiscounter</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">KieContainer</span> <span class="n">kContainer</span><span class="o">;</span>
      
      <span class="kd">public</span> <span class="nf">DroolsRuleDiscounter</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">KieServices</span> <span class="n">ks</span> <span class="o">=</span> <span class="nc">KieServices</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
          <span class="n">kContainer</span> <span class="o">=</span> <span class="n">ks</span><span class="o">.</span><span class="na">getKieClasspathContainer</span><span class="o">();</span>
      <span class="o">}</span>
      
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="nc">Money</span> <span class="nf">applyRules</span><span class="o">(</span><span class="nc">Customer</span> <span class="n">customer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">KieSession</span> <span class="n">kSession</span> <span class="o">=</span> <span class="n">kContainer</span><span class="o">.</span><span class="na">newKieSession</span><span class="o">(</span><span class="s">"discountCalculation"</span><span class="o">);</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="o">...</span> <span class="n">코드</span> <span class="n">생략</span>
              <span class="n">kSession</span><span class="o">.</span><span class="na">fireAllRules</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
              <span class="n">kSession</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">money</span><span class="o">.</span><span class="na">toImmutableMoney</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>DIP를 적용하면 저수준 모듈이 고수준 모듈에 의존하게 된다.</strong>
고수준 모듈이 저수준 모듈을 사용하는데 반대로 저수준 모듈이 고수준 모듈을 의존한다고 해서 이를 DIP(Dependency Injection, 의존 역전 원칙)이라고 부른다.</p>
  </li>
  <li>DIP를 적용하면 고수준 모듈이 저수준 모듈에 의존할 때 발생했던 두 가지 문제를 해소할 수 있다.
    <ul>
      <li>
        <p>구현 기술을 변경하더라도 <code class="language-plaintext highlighter-rouge">CalculateDiscountService</code>를 수정할 필요가 없다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// 사용할 저수준 구현 객체 변경</span>
  <span class="nc">RuleDiscounter</span> <span class="n">ruleDiscounter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleRuleDiscounter</span><span class="o">();</span>
  <span class="c1">// 사용할 저수준 모듈을 변경해도 고수준 모듈을 수정할 필요 없음</span>
  <span class="nc">CalulateDiscountService</span> <span class="n">discountService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CalculateDiscountService</span><span class="o">(</span><span class="n">ruleDiscounter</span><span class="o">);</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">CalculateDiscountService</code>가 구현 객체가 아닌 인터페이스를 사용하므로, 대역 객체를 사용해서 테스트 할 수 있다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">noCustomer_thenExceptionsShouldBeThrown</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// 테스트 목적의 대역 객체</span>
      <span class="nc">CustomerRepository</span> <span class="n">stubRepo</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">CustomerRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="n">when</span><span class="o">(</span><span class="n">stubRepo</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"noCustId"</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
      
      <span class="nc">RuleDiscounter</span> <span class="n">stubRule</span> <span class="o">=</span> <span class="o">(</span><span class="n">cust</span><span class="o">,</span> <span class="n">lines</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kc">null</span><span class="o">;</span>
      
      <span class="c1">// 대용 객체를 주입 받아 테스트 진행</span>
      <span class="nc">CalculateDiscountService</span> <span class="n">calculateDiscountService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CalculateDiscountService</span><span class="o">(</span><span class="n">stubRepo</span><span class="o">,</span> <span class="n">stubRule</span><span class="o">);</span>
      <span class="n">assertThrows</span><span class="o">(</span><span class="nc">NoCustomerException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
              <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">calculateDiscountService</span><span class="o">.</span><span class="na">calculateDiscount</span><span class="o">(</span><span class="n">someLines</span><span class="o">,</span> <span class="s">"noCustId"</span><span class="o">));</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="231-dip-주의-사항">2.3.1) DIP 주의 사항</h3>

<ul>
  <li>
    <p>DIP를 잘못 생각하면 단순히 인터페이스와 구현 클래스를 분리하는 정도로 받아들일 수 있다.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculateDiscountService</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">CustomerRepository</span> <span class="n">customerRepository</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">RuleDiscounter</span> <span class="n">ruleDiscounter</span><span class="o">;</span>
    
      <span class="kd">public</span> <span class="nf">CalculateDiscountService</span><span class="o">(</span><span class="nc">CustomerRepository</span> <span class="n">customerRepository</span><span class="o">,</span> <span class="nc">RuleDiscounter</span> <span class="n">ruleDiscounter</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">customerRepository</span> <span class="o">=</span> <span class="n">customerRepository</span><span class="o">;</span>
          <span class="k">this</span><span class="o">.</span><span class="na">ruleDiscounter</span> <span class="o">=</span> <span class="n">ruleDiscounter</span><span class="o">;</span>
      <span class="o">}</span>
    
      <span class="kd">public</span> <span class="nc">Money</span> <span class="nf">calculateDiscount</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="o">,</span> <span class="nc">String</span> <span class="n">customerId</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">findCustomer</span><span class="o">(</span><span class="n">customerId</span><span class="o">);</span>
    
          <span class="nc">MutableMoney</span> <span class="n">money</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutableMoney</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
          <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">facts</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">customer</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
          <span class="n">facts</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">orderLines</span><span class="o">);</span>
    
          <span class="n">ruleDiscounter</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="s">"discountCalculation"</span><span class="o">,</span> <span class="n">facts</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">money</span><span class="o">.</span><span class="na">toImmutableMoney</span><span class="o">();</span>
      <span class="o">}</span>
  		<span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>DIP를 적용할 때, 하위 기능을 추상화한 인터페이스는 고수준 모듈 관점에서 도출한다.</strong></p>
  </li>
</ul>

<h3 id="232-dip와-아키텍처">2.3.2) DIP와 아키텍처</h3>

<ul>
  <li>인프라스트럭처 계층이 가장 하단에 위치하는 계층형 구조와 달리 DIP를 적용하면 인프라스트럭처 영역이 응용 영역과 도메인 영역에 의존(상속)하는 구조가 된다.</li>
  <li>그래서 도메인과 응용 영역에 대한 영향을 최소화하면서 구현 기술을 변경하는 것이 가능하다.</li>
  <li>DIP를 항상 적용할 필요는 없다. 구현 범위와 추상화 정도에 따라 DIP의 이점을 얻는 수준에서 적용 범위를 검토해보자.</li>
</ul>

<h2 id="24-도메인-영역의-주요-구성요소">2.4 도메인 영역의 주요 구성요소</h2>

<table class="font-14">
  <thead>
    <tr>
      <th style="text-align: center">요소</th>
      <th style="text-align: left">설명</th>
      <th style="text-align: left">사용</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">엔티티<br />ENTITY</td>
      <td style="text-align: left">- 고유의 식별자를 갖는다.<br />- 라이프 사이클을 갖는다.<br />- 도메인의 데이터를 포함하며, 해당 데이터와 관련된 기능을 함께 제공한다.</td>
      <td style="text-align: left">- 주문(Order)<br />- 회원(Member)<br />- 상품(Product)</td>
    </tr>
    <tr>
      <td style="text-align: center">밸류<br />VALUE</td>
      <td style="text-align: left">- 고유식 식별자를 갖지 않는다.<br />- 개념적으로 하나인 값을 표현할 때 사용된다.<br />- 엔티티의 속성으로 사용할 뿐 아니라 다른 밸류 타입의 속성으로도 사용할 수 있다.</td>
      <td style="text-align: left">- 주소(Address)<br />- 금액(Money)</td>
    </tr>
    <tr>
      <td style="text-align: center">애그리거트<br /> AGGREGATE</td>
      <td style="text-align: left">- 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다.</td>
      <td style="text-align: left">[주문 애그리거트]<br />- Order 엔티티<br />- OrderLine 밸류<br />- Orderer 밸류</td>
    </tr>
    <tr>
      <td style="text-align: center">리포지터리<br /> REPOSITORY</td>
      <td style="text-align: left">- 도메인 모델의 영속성을 처리한다.</td>
      <td style="text-align: left">- 엔티티 객체를 조회<br />- 엔티티 객체를 저장</td>
    </tr>
    <tr>
      <td style="text-align: center">도메인 서비스<br /> DOMAIN SERVICE</td>
      <td style="text-align: left">- 특정 엔티티에 속하지 않은 도메인 로직을 제공한다.<br />-도메인 로직이 여러 엔티티와 밸류를 필요로 하면 도메인 서비스에서 로직을 구현한다.</td>
      <td style="text-align: left">[할인 금액 계산]<br />- 상품<br />- 쿠폰<br />- 회원 등급</td>
    </tr>
  </tbody>
</table>

<h3 id="241-앤티티와-밸류">2.4.1) 앤티티와 밸류</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">DB 테이블의 엔티티</code>  VS <code class="language-plaintext highlighter-rouge">도메인 모델의 엔티티</code>
    <ul>
      <li>
        <p><strong>도메인 모델의 엔티티는 단순히 데이터를 담고 있는 데이터 구조가 아니라 데이터와 함께 기능을 제공하는 객체이다.</strong></p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
      <span class="c1">// 주문 도메인 모델의 데이터</span>
      <span class="kd">private</span> <span class="nc">OrderNo</span> <span class="n">number</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">Orderer</span> <span class="n">orderdr</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">ShippingInfo</span> <span class="n">shippingInfo</span><span class="o">;</span>
      <span class="o">...</span>
      
      <span class="c1">// 도메인 모델 엔티티는 도메인 기능도 함께 제공</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changeShippingInfo</span><span class="o">(</span><span class="nc">ShippingInfo</span> <span class="n">newShippingInfo</span><span class="o">)</span> <span class="o">{</span>
          <span class="o">...</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>도메인 모델의 엔티티는 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입을 이용해서 표현할 수 있다.</p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Orderer</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
      <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>RDBMS 같은 관계형 데이터베이스는 밸류 타입을 제대로 표현하기 힘들다.</p>
        <ul>
          <li>한 테이블에 주문자 정보를 함께 넣으면 ‘주문자’ 개념이 드러나지 않는다.</li>
          <li>다른 테이블에 주문자 정보를 저장하면 엔티티처럼 보여, 밸류 타입의 의미가 들어나지 않는다.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>밸류는 불변으로 구현할 것을 권장하며, 이는 엔티티의 밸류 타입 데이터를 변경할 때는 객체 자체를 완전히 교체한다는 것을 의미한다.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
      <span class="kd">private</span> <span class="nc">ShippingInfo</span> <span class="n">shippingInfo</span><span class="o">;</span>
      <span class="c1">// 도메인 모델 엔티티는 도메인 기등도 함께 제공		</span>
      <span class="kd">public</span> <span class="nf">changeShippingInfo</span><span class="o">(</span><span class="nc">ShippingInfo</span> <span class="n">newShippingInfo</span><span class="o">)</span> <span class="o">{</span>
  		<span class="n">checkShippingInfoChangeable</span><span class="o">();</span>
          <span class="n">setShippingInfo</span><span class="o">(</span><span class="n">newShippingInfo</span><span class="o">);</span>
      <span class="o">}</span>
    		
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setShippingInfo</span><span class="o">(</span><span class="nc">ShippingInfo</span> <span class="n">newShippingInfo</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">newShippingInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">();</span>
          <span class="c1">// 밸류 타입의 데이터를 변경할 때는 새로운 객체로 교체한다.</span>
          <span class="k">this</span><span class="o">.</span><span class="na">shippingInfo</span> <span class="o">=</span> <span class="n">newShippingInfo</span><span class="o">;</span>
      <span class="o">}</span>
  	<span class="o">...</span>
  <span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="242-애그리거트">2.4.2) 애그리거트</h3>

<ul>
  <li>도메인이 커질수록 엔티티와 밸류 개수가 많아져 도메인 모델이 복잡해진다.</li>
  <li>도메인 모델이 복잡해지면 개발자가 전체 구조가 아닌 엔티티와 밸류에만 집중하는 상황이 발생한다.</li>
  <li>상위 수준에서 모델을 관리하지 않고 개별 요소에만 초점을 맞추다 보면, 모델을 제대로 이해하고 관리할 수 없게 된다.</li>
  <li>지도에서도 대축척 지도와 소축척 지도를 함께 봐야 현재 위치를 보다 정확하게 이해할 수 있다.</li>
  <li><strong>도메인 모델에서 전체 구조를 이해하는데 도움이 되는 것이 애그리거트이다.</strong>
    <ul>
      <li>에그리거트는 관련 객체를 하나로 묶은 군집이다.</li>
      <li>애그리거트를 사용하면 개별 객체가 아닌 관련 객체를 묶어서 객체 군집 단위로 모델을 바라볼 수 있다.</li>
      <li>애그리거트는 군집에 속한 객체를 관리하는 루트 엔티티를 갖는다.</li>
      <li>
        <p>애그리거트 루트를 통해서 간접적으로 애그리거트 내의 다른 엔티티나 밸류 객체에 접근한다.<br />
➡️  <strong>애그리거트 단위로 구현을 캡슐화</strong></p>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="nc">ShippingInfo</span> <span class="n">shippingInfo</span><span class="o">;</span>
        
    <span class="c1">// 도메인 모델 엔티티는 도메인 기등도 함께 제공		</span>
    <span class="kd">public</span> <span class="nf">changeShippingInfo</span><span class="o">(</span><span class="nc">ShippingInfo</span> <span class="n">newShippingInfo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkShippingInfoChangeable</span><span class="o">();</span>  <span class="c1">// 배송지 변경 가능 여부 확인</span>
        <span class="n">setShippingInfo</span><span class="o">(</span><span class="n">newShippingInfo</span><span class="o">);</span>
    <span class="o">}</span>
    		
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkShippingInfoChangeable</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 배송지 정보를 변경할 수 있는지 여부를 확인하는 도메인 규칙 구현</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>        </div>
      </li>
      <li>주문 애그리거트는 Order를 통하지 않고는 ShippingInfo를 변경할 수 있는 방법을 제공하지 않는다. 즉, 배송지를 변경하려면 루트 엔티티인 Order를 사용해야 하므로, 배송지 정보를 변경할 때는 Order가 구현한 도메인 로직을 항상 따르게 된다.</li>
    </ul>
  </li>
  <li><strong>애그리거트를 어떻게 구성했느냐에 따라 구현 복잡도와 트랜잭션 범위가 달라진다.</strong></li>
</ul>

<h3 id="243-리포지터리">2.4.3) 리포지터리</h3>

<ul>
  <li>도메인 객체를 지속적으로 사용하려면  물리적인 저장소에 도메인 객체를 보관해야 하는데, 이를 위한 도메인 모델이 리포지터리이다.</li>
  <li>
    <p>리포지터리는 애그리거트 단위로 도메인 객체를 저장하고 조회하는 기능을 정의한다.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="o">{</span>
      <span class="nc">Order</span> <span class="nf">findByNumber</span><span class="o">(</span><span class="nc">OrderNumber</span> <span class="n">orderNumber</span><span class="o">);</span>
      <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">);</span>
      <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>객체를 조회하고 저장하는 단위가 애그리거트 루트인 <code class="language-plaintext highlighter-rouge">Order</code>이다.</li>
    </ul>
  </li>
  <li>도메인 모델 관점에서 <code class="language-plaintext highlighter-rouge">OrderRepository</code>는 도메인 객체를 영속화하는데 필요한 기능을 추상화한 것으로 고수준 모듈에 속한다.</li>
  <li>기반 기술을 이용해서 <code class="language-plaintext highlighter-rouge">OrderRepositoy</code>를 구현한 클래스는 저수준 모듈로 인프라스트럭처 영역에 속한다.</li>
  <li>응용 서비스와 리포지터리는 밀접한 연관이 있다.
    <ul>
      <li>응용 서비스는 필요한 도메인 객체를 조회하거나 저장할 때 리포지터리를 사용한다.</li>
      <li>응용 서비스는 트랜잭션을 관리하는데, 트랜잭션 처리는 리포지터리 구현 기술의 영향을 받는다.</li>
    </ul>
  </li>
</ul>

<h2 id="25-요청-처리-흐름">2.5 요청 처리 흐름</h2>

<ul>
  <li>도메인의 상태를 변경해야 하는 경우, 변경된 상태가 올바르게 반영되도록 트랜잭션 관리가 필요하다.
    <ul>
      <li>스프링프레임워크를 사용하면 <code class="language-plaintext highlighter-rouge">@Transactional</code> 애너테이션으로 트랜잭션을 처리할 수 있다.</li>
    </ul>
  </li>
</ul>

<h2 id="26-인프라스트럭처">2.6 인프라스트럭처</h2>

<ul>
  <li>인프라스트럭처는 표현 영역, 응용 영역, 도메인 영역을 지원한다.</li>
  <li>도메인 영역과 응용 영역에서 인프라스트럭처 기능을 직접 사용하는 것보다 DIP를 적용하여 시스템을 더 유연하고 테스트하기 쉽게 만들 수 있다.</li>
  <li>하지만 무조건 인프라스트럭처에 대한 의존을 없앨 필요는 없다.
    <ul>
      <li>트랜잭션 처리를 위한 <code class="language-plaintext highlighter-rouge">@Transactional</code> 애너테이션</li>
      <li>JPA 전용 애너테이션 - <code class="language-plaintext highlighter-rouge">@Entity</code>, <code class="language-plaintext highlighter-rouge">@Table</code> 등</li>
    </ul>
  </li>
  <li>구현의 편리함은 DIP가 주는 다른 장점 만큼 중요하기 때문에, DIP의 장점을 헤치치 않는 범위에서 사용하는 것이 좋다.</li>
</ul>

<h2 id="27-모듈-구성">2.7 모듈 구성</h2>

<ul>
  <li>아키텍처의 각 영역은 별도 패키지에 위치한다.</li>
  <li>패키지 구성 규칙에 정답이 존재하는 것은 아니지만, 같은 영역별로 모듈이 위치할 패키지를 구성할 수 있다.</li>
  <li>도메인이 크면 하위 도메인으로 나누고, 각 하위 도메인마다 별도 패키지를 구성한다.</li>
  <li>도메인 모듈은 도메인이 속한 애그리거트를 기준으로 다시 패키지를 구성한다.</li>
  <li>애그리거트, 모델, 리포지터리는 같은 패키지에 위치시킨다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">shop.order.domain.order</code> : 애그리거트 위치</li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">shop.order.domain.service</code> : 도메인 서비스 위치</p>
      </li>
      <li>
        <p>도메인이 복잡하면 도메인 모델과 도메인 서비스를 별도 패키지에 위치시킬 수도 있다.</p>

        <ul>
          <li><code class="language-plaintext highlighter-rouge">shop.catalog.application.product</code></li>
          <li><code class="language-plaintext highlighter-rouge">shop.catalog.application.catetory</code></li>
        </ul>
      </li>
    </ul>

    <p>➡️  모듈 구조를 얼마나 세분화해야 하는지에 대해 정해진 규칙은 없다. 보통 한 패키지에 10~15개 미만으로 유지하는 편이다.</p>
  </li>
</ul>

<p><br /><br /><br /></p>

  </div>

</article>

      </div>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer"><div class="copyright">
            
            <p>Copyright &copy; 2022 Chloe.</p>
            
          </div>    
        </footer>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js"></script>
    <script type="text/javascript">
      const lightbox = GLightbox({
          touchNavigation: true,
          loop: true,
          autoplayVideos: true
      });
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js" integrity="sha384-GxNFqL3r9uRJQhR+47eDxuPoNE7yLftQM8LcxzgS4HT73tp970WS/wV5p8UzCOmb" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"
            onload="renderMathInElement(document.body,{
                    delimiters: [
                    { left: '$$',  right: '$$',  display: true  },
                    { left: '$',   right: '$',   display: false },
                    { left: '\\[', right: '\\]', display: true  },
                    { left: '\\(', right: '\\)', display: false }
                    ]});">
    </script>
  </body>
</html>
